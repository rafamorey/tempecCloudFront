<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style/style.css">
  <title>Document</title>
</head>
<body>
  <header >
    <div class="headerLogo">
      <img src="./icons/icono.jpg" alt="">
    </div>
    <div class="title">  
      <h1>Diinpec</h1>
    </div>
  </header>

    <section class="menu">
      <ul>
        <li><a class="linkMenuOption" href="./device.html">Home</a></li>
        <li><a class="linkMenuOption" href="./dashboard.html">Dashboard</a></li>
        <li><a class="linkMenuOption" id="historyBtn" href="./history.html">History</a></li>
        <li><a class="linkMenuOption" href="./config.html">Configuration</a></li>
        <li><div id="signOut" class="linkMenuOption">Sign out</div></li>
      </ul>
    </section>
    <section class="sectionChart">
      <div class="chartContainer" >
        <canvas id="myChart">
        </canvas>
      </div>
    </section>
    <div class="valuesContainer">
      <div class="minValueButtonContainer">
        <div class="divValue" id="divMin"></div>
        <div class="divContainerRefresh">
          <img class="divRefresh" id="divMinRe" src="./icons/refresh.png" alt="">
        </div>
      </div>
      <div class="divValue" id="divSetpoint"></div>
      <div class="minValueButtonContainer">
        <div class="divValue" id="divMax"></div>
        <div class="divContainerRefresh">
          <img id="divMaxRe"class="divRefresh" src="./icons/refresh.png" alt="">
        </div>
        
      </div>
    </div>
  
    
  <footer>
    <div class="cr">
      Copyright 1995-2022 DIINPEC. Todods los derechos reservados
    </div>
    <div class="legal">
      <ul class="legalTerms">
        <li>Mexico</li>
        <li>Accesibilidad</li>
        <li>Terminos y condiciones</li>
        <li>Privacidad</li>
        <li>Legales</li>
      </ul>
      <ul class="legalSocial">
        <li>SIGUENOS EN</li>
        <li>logoF</li>
        <li>logoT</li>
        <li>logoI</li>
        <li>logoL</li>
      </ul>    
    </div>
    
  </footer>
  <!-- <script src="./src/dashboard.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>

    api_urlDevice = 'https://tempec.vercel.app/device/'

    const refreshMinButton = document.getElementById('divMinRe')
    const refreshMaxButton = document.getElementById('divMaxRe')

    refreshMaxButton.addEventListener('click', () => {
      refreshMaxValue(deviceDataParser)
    })

    refreshMinButton.addEventListener('click', () => {
      refreshMinValue(deviceDataParser)
    })

    async function refreshMinValue(device){
      
      console.log("device")
      console.log(device)
      console.log("deviceDataParser")
      console.log(deviceDataParser)
      console.log("deviceValuesParser")
      console.log(deviceValuesParser)
      console.log("deviceStatusParser")
      console.log(deviceDParser)

      const res = await fetch(`${api_urlDevice}refreshMin`,{
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          "enterprise": deviceDParser.enterprise,
          "name": device.name,
          "id": device.id,
          "setPoint": device.setPoint,
          "date": deviceValues.body.tempDates.slice(-1).pop()
        })
      })
      const data = await res.json() 
    if(res.status !== 201){
      console.log('No se encontro device')
    } else{
      console.log(data)
      // localStorage.setItem('deviceData', JSON.stringify(device))
      // localStorage.setItem('deviceStatus', JSON.stringify(data))
      getValuesDevice(device)
        // window.location.href = 'http://127.0.0.1:5501/dashboard.html'
  }
    }

    async function refreshMaxValue(device){
      console.log("device")
      console.log(device)

      const res = await fetch(`${api_urlDevice}refreshMax`,{
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          "enterprise": deviceDParser.enterprise,
          "name": device.name,
          "id": device.id,
          "setPoint": device.setPoint
        })
      })
      const data = await res.json() 
  if(res.status !== 200){
    console.log('No se encontro device')
  } else{
    console.log(data)
    // localStorage.setItem('deviceData', JSON.stringify(device))
    // localStorage.setItem('deviceStatus', JSON.stringify(data))
    // getValuesDevice(device)
      // window.location.href = 'http://127.0.0.1:5501/dashboard.html'
  }
    }

    async function getStatusDevice(device){
  console.log("device values coming...")
  console.log(device)
  const res = await fetch(`${api_urlDevice}status`,{
    method:'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      "enterprise": device.enterprise,
      "name": device.name,
      "id": device.id
    })
  })
  const data = await res.json() 
  if(res.status !== 200){
    console.log('No se encontro device')
  } else{
    console.log(data)
    localStorage.setItem('deviceData', JSON.stringify(device))
    localStorage.setItem('deviceStatus', JSON.stringify(data))
    getValuesDevice(device)
      // window.location.href = 'http://127.0.0.1:5501/dashboard.html'
  }
}

    async function getValuesDevice(device){
  console.log("device values coming...")
  console.log(device)
  const res = await fetch(`${api_urlDevice}deviceValues`,{
    method:'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      "enterprise": deviceDParser.enterprise,
      "name": device.name,
      "id": device.id
    })
  })
  const data = await res.json() 
  if(res.status !== 200){
    console.log('No se encontro device')
  } else{
    console.log(data)
    localStorage.setItem('deviceValues', JSON.stringify(data))
    // window.location.href = 'http://127.0.0.1:5501/public/dashboard.html'
    // window.location.href = 'https://uctempec.vercel.app/dashboard.html'
  }
}

      const btnSignOut = document.getElementById('signOut')
      btnSignOut.addEventListener('click', ()=>{
      localStorage.removeItem('deviceData')
      localStorage.removeItem('deviceStatus')
      localStorage.removeItem('deviceValues')
      localStorage.removeItem('1')
      localStorage.removeItem('dataDates')

    // window.location.href = 'http://127.0.0.1:5501/public/index.html'
      window.location.href = 'https://uctempec.vercel.app/index.html'

})
    // url
      const last = deviceValuesParser.body.tempDates.slice(-1).pop()
      console.log(last)
      console.log(deviceValues.body.tempDates.slice(-1).pop())
      const deviceData = localStorage.getItem('deviceData')
      const deviceDataParser = JSON.parse(deviceData)
      console.log(deviceDataParser)
    
      const deviceValues = localStorage.getItem('deviceValues')
      const deviceValuesParser = JSON.parse(deviceValues)
      console.log(deviceValuesParser)

      const deviceD = localStorage.getItem('1')
      const deviceDParser = JSON.parse(deviceD)
      console.log(deviceDParser)
    
      const divMin = document.getElementById('divMin')
      divMinTextNode = document.createTextNode(deviceDataParser.tempMin)
      divMin.appendChild(divMinTextNode)
    
      const divSetpoint = document.getElementById('divSetpoint')
      divSetpointTextNode = document.createTextNode(deviceDataParser.setPoint)
      divSetpoint.appendChild(divSetpointTextNode)
    
    
      const divMax = document.getElementById('divMax')
      divMaxTextNode = document.createTextNode(deviceDataParser.tempMax)
      divMax.appendChild(divMaxTextNode)
    
    
      const inputHistory = document.getElementById('historyBtn')
      inputHistory.addEventListener('click', () => {
      // window.location.href = 'https://uctempec.vercel.app/history.html'
    })
    
    
    
    const labels = deviceValuesParser.body.tempDates
    
    const data = {
      labels: labels,
      datasets: [
      {
        label: 'Min Limit',
        backgroundColor: '#008CBA',
        borderColor: '#008CBA',
        data: deviceValuesParser.body.tempMin
      },
      {
        label: 'temperature',
        backgroundColor: '#4CAF50',
        borderColor: '#4CAF50',
        data: deviceValuesParser.body.temperatures
      },
      {
        label: 'Max Limit',
        backgroundColor: '#f44336',
        borderColor: '#f44336',
        data: deviceValuesParser.body.tempMax
      }]
    };
  
    const config = {
      type: 'line',
      data: data,
      options: {
        maintainAspectRatio: false,
      }
    };

      getStatusDevice(deviceDataParser)
    </script>
  <script>
    const myChart = new Chart(
      document.getElementById('myChart'),
      config
      );


      </script>

</body>
</html>